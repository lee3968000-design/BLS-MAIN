<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>13ê°„ì§€ í† ë„ˆë¨¼íŠ¸</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ë°” */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #eee; border-radius: 10px; flex-wrap: wrap; gap: 10px;}
        .home-btn { background: #636e72; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;}
        .home-btn:hover { background: #2d3436; }
        
        .timer { font-weight: bold; font-size: 20px; color: #d63031; min-width: 80px; text-align: right;}

        /* ë ˆì´ì•„ì›ƒ: ì¢Œ(í‘œ) ìš°(ì»¨íŠ¸ë¡¤) */
        .game-layout { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start; }
        
        /* 14x14 í‘œ ìŠ¤íƒ€ì¼ */
        .grid-wrapper { overflow-x: auto; max-width: 100%; border: 1px solid #ccc; border-radius: 5px;}
        table { border-collapse: collapse; font-size: 11px; margin: 0 auto; white-space: nowrap; }
        th, td { border: 1px solid #ddd; width: 35px; height: 30px; text-align: center; vertical-align: middle; padding: 2px;}
        .header { background: #2d3436; color: white; font-weight: bold; }
        .self { background: #000; }
        .win { background: #0984e3; color: white; }
        .lose { background: #d63031; color: white; }

        /* ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .control-area { width: 320px; text-align: left; padding: 20px; background: #fafafa; border-radius: 10px; border: 1px solid #ddd; flex-shrink: 0;}
        
        /* ëŒ€ì§„í‘œ ìŠ¤íƒ€ì¼ */
        .bracket-box { margin-bottom: 20px; font-size: 15px; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee;}
        .bracket-title { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #333; border-bottom: 2px solid #333; padding-bottom: 5px;}
        .match-group { margin-bottom: 8px; }
        .match-label { font-weight: bold; color: #6c5ce7; margin-right: 5px; }

        /* ì…ë ¥ì°½ */
        input { padding: 12px; width: 60%; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; }
        input:focus { border-color: #0984e3; outline: none; }
        
        .feedback { margin-top: 10px; font-weight: bold; font-size: 16px; min-height: 30px; }
        
        /* ë¦¬ë”ë³´ë“œ */
        .leaderboard { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
        .rank-list { max-height: 250px; overflow-y: auto; }
        .rank-item { font-size: 14px; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;}
        .rank-1 { color: #d63031; font-weight: bold; background-color: #fff0f0; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <button class="home-btn" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
        <div style="display:flex; gap:5px;">
            <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" style="width: 80px; font-size:14px;">
            <button onclick="startGame()" style="padding:10px 15px; background:#00b894; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">ê²Œì„ ì‹œì‘</button>
        </div>
        <div id="timer-display" class="timer">0.00ì´ˆ</div>
    </div>

    <h1>ğŸ² 13ê°„ì§€ í† ë„ˆë¨¼íŠ¸</h1>

    <div class="game-layout">
        <div class="grid-wrapper">
            <table id="zodiac-table">
                <tr><td colspan="14" style="padding:20px;">'ê²Œì„ ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
            </table>
        </div>

        <div class="control-area">
            <div class="bracket-title">ğŸ± 8ê°• ëŒ€ì§„í‘œ</div>
            <div id="bracket-display" class="bracket-box">
                ëŒ€ê¸° ì¤‘...
            </div>

            <div style="margin-top: 20px;">
                <p style="margin-bottom: 5px; font-weight:bold;">ğŸ† ìµœì¢… ìš°ìŠ¹ìëŠ”?</p>
                <input type="text" id="user-answer" placeholder="ì •ë‹µ ì…ë ¥" onkeydown="if(event.key === 'Enter') checkAnswer()" disabled>
                <div id="feedback-msg" class="feedback"></div>
            </div>

            <div class="leaderboard">
                <h4>ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹ (Top 20)</h4>
                <div id="rank-list" class="rank-list">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // [ì„¤ì •] ì‚¬ìš©ì ì •ë³´ ë°˜ì˜ ì™„ë£Œ
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
        authDomain: "bsar5-d7818.firebaseapp.com",
        databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
        projectId: "bsar5-d7818",
        storageBucket: "bsar5-d7818.firebasestorage.app",
        messagingSenderId: "377629207721",
        appId: "1:377629207721:web:8b893496c0ac1749890db8",
        measurementId: "G-M9FJXYTS3F"
    };

    // Firebase ì´ˆê¸°í™”
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ì „ì—­ ë³€ìˆ˜
    const ANIMALS = ["ì¥", "ì†Œ", "í˜¸ë‘ì´", "í† ë¼", "ìš©", "ë±€", "ë§", "ì–‘", "ì›ìˆ­ì´", "ë‹­", "ê°œ", "ë¼ì§€", "ê³ ì–‘ì´"];
    let problems = []; 
    let currentProblem = null;
    let startTime = 0;
    let timerInterval = null;

    // ì´ˆê¸° ì‹¤í–‰
    window.onload = function() {
        loadProblems();
        loadLeaderboard();
    };

    // 1. ë¬¸ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (zodiac_problems ê²½ë¡œ)
    function loadProblems() {
        const msg = document.getElementById('feedback-msg');
        msg.innerText = "ë¬¸ì œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        
        // ì¤‘ìš”: DBì— 'zodiac_problems'ë¼ëŠ” í‚¤ë¡œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí–ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
        db.ref('zodiac_problems').once('value').then(snap => {
            const data = snap.val();
            if(!data) {
                msg.innerText = "âš ï¸ DBì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. (zodiac_makerë¡œ ë§Œë“  ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”)";
                msg.style.color = "red";
                return;
            }
            
            // ë°ì´í„°ê°€ ë°°ì—´ì¸ì§€ ê°ì²´ì¸ì§€ í™•ì¸ í›„ ë°°ì—´ë¡œ ë³€í™˜
            if(Array.isArray(data)) {
                problems = data;
            } else {
                problems = Object.values(data);
            }
            
            msg.innerText = `ì¤€ë¹„ ì™„ë£Œ! (ì´ ${problems.length}ë¬¸ì œ)`;
            msg.style.color = "blue";
        }).catch(err => {
            console.error(err);
            msg.innerText = "ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜";
        });
    }

    // 2. ê²Œì„ ì‹œì‘
    function startGame() {
        const nick = document.getElementById('nickname').value.trim();
        if(!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if(problems.length === 0) return alert("ë¡œë”©ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");

        // ëœë¤ ë¬¸ì œ ì„ íƒ
        const randIdx = Math.floor(Math.random() * problems.length);
        currentProblem = problems[randIdx];

        // UI ì´ˆê¸°í™”
        const input = document.getElementById('user-answer');
        input.value = "";
        input.disabled = false;
        input.focus();
        document.getElementById('feedback-msg').innerText = "";
        
        // íƒ€ì´ë¨¸ ì‹œì‘
        if(timerInterval) clearInterval(timerInterval);
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const now = Date.now();
            document.getElementById('timer-display').innerText = ((now - startTime) / 1000).toFixed(2) + "ì´ˆ";
        }, 30);

        renderTable(currentProblem.matrix);
        renderBracket(currentProblem.brackets);
    }

    // 3. ìƒì„±í‘œ ê·¸ë¦¬ê¸°
    function renderTable(matrix) {
        const table = document.getElementById('zodiac-table');
        table.innerHTML = "";

        // í—¤ë” í–‰
        let thead = "<tr><th class='header'>VS</th>";
        ANIMALS.forEach(a => thead += `<th class='header'>${a}</th>`);
        thead += "</tr>";
        table.innerHTML += thead;

        // ë°ì´í„° í–‰
        for (let i = 0; i < 13; i++) {
            let row = `<tr><th class='header'>${ANIMALS[i]}</th>`;
            for (let j = 0; j < 13; j++) {
                const val = matrix[i][j];
                if (val === -1) {
                    row += "<td class='self'></td>";
                } else if (val === 1) {
                    row += "<td class='win'>ìŠ¹</td>"; // ê³µê°„ ì ˆì•½ì„ ìœ„í•´ 'ìŠ¹' í•œê¸€ì
                } else {
                    row += "<td class='lose'>íŒ¨</td>";
                }
            }
            row += "</tr>";
            table.innerHTML += row;
        }
    }

    // 4. ëŒ€ì§„í‘œ í…ìŠ¤íŠ¸ ì¶œë ¥
    function renderBracket(brackets) {
        const box = document.getElementById('bracket-display');
        let html = "";
        
        html += `<div class="match-group"><span class="match-label">[ê°€]</span> ${brackets[0][0]} vs ${brackets[0][1]}</div>`;
        html += `<div class="match-group"><span class="match-label">[ë‚˜]</span> ${brackets[1][0]} vs ${brackets[1][1]}</div>`;
        html += `<div style="border-bottom:1px dashed #ccc; margin:10px 0;"></div>`;
        html += `<div class="match-group"><span class="match-label">[ë‹¤]</span> ${brackets[2][0]} vs ${brackets[2][1]}</div>`;
        html += `<div class="match-group"><span class="match-label">[ë¼]</span> ${brackets[3][0]} vs ${brackets[3][1]}</div>`;
        
        html += `<p style='font-size:13px; color:#666; margin-top:15px;'>
            ğŸ’¡ ì§„í–‰ ë°©ì‹:<br>
            1. (ê°€)ìŠ¹ì vs (ë‚˜)ìŠ¹ì = ê²°ìŠ¹ ì§„ì¶œ A<br>
            2. (ë‹¤)ìŠ¹ì vs (ë¼)ìŠ¹ì = ê²°ìŠ¹ ì§„ì¶œ B<br>
            3. A vs B = <b>ìµœì¢… ìš°ìŠ¹ì</b>
        </p>`;
        box.innerHTML = html;
    }

    // 5. ì •ë‹µ ì²´í¬
    function checkAnswer() {
        const input = document.getElementById('user-answer').value.trim();
        const feedback = document.getElementById('feedback-msg');

        if (!input) return;

        if (input === currentProblem.answer) {
            // ì •ë‹µ
            clearInterval(timerInterval);
            const clearTime = ((Date.now() - startTime) / 1000).toFixed(2);
            
            feedback.style.color = "#00b894"; 
            feedback.innerText = `ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! (${clearTime}ì´ˆ)`;
            document.getElementById('user-answer').disabled = true;

            // ê¸°ë¡ ì €ì¥
            saveRecord(clearTime);

        } else {
            // ì˜¤ë‹µ
            feedback.style.color = "#d63031"; 
            feedback.innerText = `âŒ ë•¡! (${input} ì•„ë‹˜)`;
            document.getElementById('user-answer').value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            document.getElementById('user-answer').focus();
        }
    }

    // 6. Firebase ê¸°ë¡ ì €ì¥
    function saveRecord(time) {
        const nick = document.getElementById('nickname').value;
        db.ref('zodiac_leaderboard').push({
            nickname: nick,
            time: parseFloat(time),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // 7. Firebase ë¦¬ë”ë³´ë“œ ë¡œë“œ
    function loadLeaderboard() {
        const list = document.getElementById('rank-list');
        // ì‹œê°„ ì˜¤ë¦„ì°¨ìˆœ (ë‚®ì€ ì‹œê°„ ìˆœ)
        db.ref('zodiac_leaderboard').orderByChild('time').limitToFirst(20).on('value', snap => {
            list.innerHTML = "";
            const data = snap.val();
            if(!data) {
                list.innerHTML = "<div style='padding:10px; color:#999;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                return;
            }

            // Firebase ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
            let arr = [];
            snap.forEach(child => arr.push(child.val()));

            arr.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `rank-item ${idx===0?'rank-1':''}`;
                div.innerHTML = `
                    <span>${idx+1}ìœ„ <b>${item.nickname}</b></span>
                    <span style="font-weight:bold; color:${idx===0?'#d63031':'#0984e3'}">${item.time}ì´ˆ</span>
                `;
                list.appendChild(div);
            });
        });
    }
</script>

</body>
</html>