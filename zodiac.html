<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>13ê°„ì§€ í† ë„ˆë¨¼íŠ¸</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ë°” */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #eee; border-radius: 10px; flex-wrap: wrap; gap: 10px;}
        .home-btn { background: #636e72; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;}
        .home-btn:hover { background: #2d3436; }
        
        .control-group { display: flex; gap: 5px; align-items: center; }
        select, input { padding: 10px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-move { padding:10px 15px; background:#00b894; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        .btn-move:hover { background: #00a383; }
        .btn-next { padding:10px 15px; background:#0984e3; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin-left: 5px;}
        .btn-next:hover { background: #0077c8; }

        .timer { font-weight: bold; font-size: 20px; color: #d63031; min-width: 80px; text-align: right;}

        /* ë ˆì´ì•„ì›ƒ */
        .game-layout { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start; }
        
        /* í‘œ ìŠ¤íƒ€ì¼ */
        .grid-wrapper { overflow-x: auto; max-width: 100%; border: 1px solid #ccc; border-radius: 5px;}
        table { border-collapse: collapse; font-size: 11px; margin: 0 auto; white-space: nowrap; }
        th, td { border: 1px solid #ddd; width: 35px; height: 30px; text-align: center; vertical-align: middle; padding: 2px;}
        .header { background: #2d3436; color: white; font-weight: bold; }
        .self { background: #000; }
        .win { background: #0984e3; color: white; }
        .lose { background: #d63031; color: white; }

        /* ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .control-area { width: 320px; text-align: left; padding: 20px; background: #fafafa; border-radius: 10px; border: 1px solid #ddd; flex-shrink: 0;}
        
        .bracket-box { margin-bottom: 20px; font-size: 15px; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee;}
        .bracket-title { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #333; border-bottom: 2px solid #333; padding-bottom: 5px;}
        .match-group { margin-bottom: 8px; }
        .match-label { font-weight: bold; color: #6c5ce7; margin-right: 5px; }

        .answer-input { padding: 12px; width: 60%; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; }
        .answer-input:focus { border-color: #0984e3; outline: none; }
        
        .feedback { margin-top: 10px; font-weight: bold; font-size: 16px; min-height: 30px; }
        
        .leaderboard { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
        .rank-title { font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #555; }
        .rank-list { max-height: 250px; overflow-y: auto; }
        .rank-item { font-size: 14px; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;}
        .rank-1 { color: #d63031; font-weight: bold; background-color: #fff0f0; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <button class="home-btn" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
        
        <div class="control-group">
            <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" style="width: 80px;">
            
            <select id="q-select">
                <option value="">ë¡œë”© ì¤‘...</option>
            </select>
            
            <button class="btn-move" onclick="startGame()">ì´ë™</button>
            <button class="btn-next" onclick="nextProblem()">ë‹¤ìŒ ë¬¸ì œ â–¶</button>
        </div>
        
        <div id="timer-display" class="timer">0.00ì´ˆ</div>
    </div>

    <h1>ğŸ² 13ê°„ì§€ í† ë„ˆë¨¼íŠ¸</h1>

    <div class="game-layout">
        <div class="grid-wrapper">
            <table id="zodiac-table">
                <tr><td colspan="14" style="padding:20px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </table>
        </div>

        <div class="control-area">
            <div class="bracket-title">ğŸ± 8ê°• ëŒ€ì§„í‘œ</div>
            <div id="bracket-display" class="bracket-box">
                ëŒ€ê¸° ì¤‘...
            </div>

            <div style="margin-top: 20px;">
                <p style="margin-bottom: 5px; font-weight:bold;">ğŸ† ìµœì¢… ìš°ìŠ¹ìëŠ”?</p>
                <input type="text" id="user-answer" class="answer-input" placeholder="ì •ë‹µ ì…ë ¥" onkeydown="if(event.key === 'Enter') checkAnswer()" disabled>
                <div id="feedback-msg" class="feedback"></div>
            </div>

            <div class="leaderboard">
                <div id="rank-title" class="rank-title">ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹</div>
                <div id="rank-list" class="rank-list">ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
        authDomain: "bsar5-d7818.firebaseapp.com",
        databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
        projectId: "bsar5-d7818",
        storageBucket: "bsar5-d7818.firebasestorage.app",
        messagingSenderId: "377629207721",
        appId: "1:377629207721:web:8b893496c0ac1749890db8",
        measurementId: "G-M9FJXYTS3F"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const ANIMALS = ["ì¥", "ì†Œ", "í˜¸ë‘ì´", "í† ë¼", "ìš©", "ë±€", "ë§", "ì–‘", "ì›ìˆ­ì´", "ë‹­", "ê°œ", "ë¼ì§€", "ê³ ì–‘ì´"];
    let problems = []; 
    let currentProblem = null;
    let currentQIndex = -1; 
    let startTime = 0;
    let timerInterval = null;
    let rankListener = null; // ë¦¬ë”ë³´ë“œ ë¦¬ìŠ¤ë„ˆ ê´€ë¦¬ìš©

    window.onload = function() {
        loadProblems();
    };

    // 1. ë¬¸ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function loadProblems() {
        const msg = document.getElementById('feedback-msg');
        
        db.ref('zodiac_problems').once('value').then(snap => {
            const data = snap.val();
            if(!data) {
                msg.innerText = "âš ï¸ ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            if(Array.isArray(data)) {
                problems = data;
            } else {
                problems = Object.values(data);
            }
            
            // ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            const select = document.getElementById('q-select');
            select.innerHTML = "";
            problems.forEach((_, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = `ë¬¸ì œ ${idx + 1}`;
                select.appendChild(opt);
            });

            // ë¡œë”© ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ 1ë²ˆ ë¬¸ì œ ì‹œì‘
            startGame();
        });
    }

    // 2. ê²Œì„ ì‹œì‘ (í˜„ì¬ ì„ íƒëœ ë¬¸ì œë¡œ)
    function startGame() {
        const nick = document.getElementById('nickname').value.trim();
        const select = document.getElementById('q-select');
        
        if(problems.length === 0) return; // ì•„ì§ ë¡œë”© ì•ˆë¨
        
        // ì„ íƒëœ ì¸ë±ìŠ¤
        const idx = parseInt(select.value || 0);
        currentQIndex = idx;
        currentProblem = problems[idx];

        // UI ì´ˆê¸°í™”
        const input = document.getElementById('user-answer');
        input.value = "";
        input.disabled = false;
        input.focus();
        document.getElementById('feedback-msg').innerText = "";
        
        // íƒ€ì´ë¨¸ ì‹œì‘
        if(timerInterval) clearInterval(timerInterval);
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const now = Date.now();
            document.getElementById('timer-display').innerText = ((now - startTime) / 1000).toFixed(2) + "ì´ˆ";
        }, 30);

        renderTable(currentProblem.matrix);
        renderBracket(currentProblem.brackets);

        // â˜… í•µì‹¬: í•´ë‹¹ ë¬¸ì œì˜ ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
        loadLeaderboard(currentQIndex);
    }

    // 3. ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
    function nextProblem() {
        const select = document.getElementById('q-select');
        let nextIdx = currentQIndex + 1;

        if (nextIdx >= problems.length) {
            alert("ë§ˆì§€ë§‰ ë¬¸ì œê¹Œì§€ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤!");
            return;
        }

        // ë“œë¡­ë‹¤ìš´ ê°’ ë³€ê²½ í›„ ê²Œì„ ì‹œì‘
        select.value = nextIdx;
        startGame();
    }

    function renderTable(matrix) {
        const table = document.getElementById('zodiac-table');
        table.innerHTML = "";
        let thead = "<tr><th class='header'>VS</th>";
        ANIMALS.forEach(a => thead += `<th class='header'>${a}</th>`);
        thead += "</tr>";
        table.innerHTML += thead;

        for (let i = 0; i < 13; i++) {
            let row = `<tr><th class='header'>${ANIMALS[i]}</th>`;
            for (let j = 0; j < 13; j++) {
                const val = matrix[i][j];
                if (val === -1) row += "<td class='self'></td>";
                else if (val === 1) row += "<td class='win'>ìŠ¹</td>";
                else row += "<td class='lose'>íŒ¨</td>";
            }
            row += "</tr>";
            table.innerHTML += row;
        }
    }

    function renderBracket(brackets) {
        const box = document.getElementById('bracket-display');
        let html = "";
        html += `<div class="match-group"><span class="match-label">[ê°€]</span> ${brackets[0][0]} vs ${brackets[0][1]}</div>`;
        html += `<div class="match-group"><span class="match-label">[ë‚˜]</span> ${brackets[1][0]} vs ${brackets[1][1]}</div>`;
        html += `<div style="border-bottom:1px dashed #ccc; margin:10px 0;"></div>`;
        html += `<div class="match-group"><span class="match-label">[ë‹¤]</span> ${brackets[2][0]} vs ${brackets[2][1]}</div>`;
        html += `<div class="match-group"><span class="match-label">[ë¼]</span> ${brackets[3][0]} vs ${brackets[3][1]}</div>`;
        html += `<p style='font-size:13px; color:#666; margin-top:15px;'>ğŸ’¡ ê°€vsë‚˜ ìŠ¹ì / ë‹¤vsë¼ ìŠ¹ì ëŒ€ê²° í›„ ê²°ìŠ¹</p>`;
        box.innerHTML = html;
    }

    function checkAnswer() {
        const input = document.getElementById('user-answer').value.trim();
        const feedback = document.getElementById('feedback-msg');
        const nick = document.getElementById('nickname').value.trim();

        if (!input) return;

        if (input === currentProblem.answer) {
            clearInterval(timerInterval);
            const clearTime = ((Date.now() - startTime) / 1000).toFixed(2);
            feedback.style.color = "#00b894"; 
            feedback.innerText = `ğŸ‰ ì •ë‹µ! (${clearTime}ì´ˆ)`;
            document.getElementById('user-answer').disabled = true;
            
            if(nick) saveRecord(clearTime); // ë‹‰ë„¤ì„ ìˆìœ¼ë©´ ì €ì¥
        } else {
            feedback.style.color = "#d63031"; 
            feedback.innerText = `âŒ ë•¡! (${input} ì•„ë‹˜)`;
            document.getElementById('user-answer').value = ""; 
            document.getElementById('user-answer').focus();
        }
    }

    // â˜… 4. ê¸°ë¡ ì €ì¥ (ë¬¸ì œë³„ í´ë” ë¶„ë¦¬)
    function saveRecord(time) {
        const nick = document.getElementById('nickname').value;
        // ê²½ë¡œ: zodiac_leaderboard / ë¬¸ì œë²ˆí˜¸ / ê¸°ë¡
        db.ref(`zodiac_leaderboard/${currentQIndex}`).push({
            nickname: nick,
            time: parseFloat(time),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // â˜… 5. ë¦¬ë”ë³´ë“œ ë¡œë“œ (í•´ë‹¹ ë¬¸ì œë§Œ)
    function loadLeaderboard(problemIdx) {
        const list = document.getElementById('rank-list');
        const title = document.getElementById('rank-title');
        title.innerText = `ğŸ… [ë¬¸ì œ ${problemIdx + 1}] ëª…ì˜ˆì˜ ì „ë‹¹`;
        list.innerHTML = "ë¡œë”© ì¤‘...";

        // ì´ì „ ë¦¬ìŠ¤ë„ˆ ì œê±° (ë‹¤ë¥¸ ë¬¸ì œ ë°ì´í„° ì„ì„ ë°©ì§€)
        if (rankListener) {
            db.ref().off('value', rankListener);
        }

        // í•´ë‹¹ ë¬¸ì œì˜ ê²½ë¡œë§Œ ë°”ë¼ë´„
        const query = db.ref(`zodiac_leaderboard/${problemIdx}`).orderByChild('time').limitToFirst(20);
        
        rankListener = query.on('value', snap => {
            list.innerHTML = "";
            const data = snap.val();
            if(!data) {
                list.innerHTML = "<div style='padding:10px; color:#999;'>ì•„ì§ ì •ë‹µìê°€ ì—†ìŠµë‹ˆë‹¤. 1ë“±ì„ ë…¸ë ¤ë³´ì„¸ìš”!</div>";
                return;
            }
            
            let arr = [];
            snap.forEach(child => arr.push(child.val()));
            
            arr.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `rank-item ${idx===0?'rank-1':''}`;
                div.innerHTML = `
                    <span>${idx+1}ìœ„ <b>${item.nickname}</b></span>
                    <span style="font-weight:bold; color:${idx===0?'#d63031':'#0984e3'}">${item.time}ì´ˆ</span>
                `;
                list.appendChild(div);
            });
        });
    }
</script>

</body>
</html>