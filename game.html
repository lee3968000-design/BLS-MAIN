<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—­ìŒê·¼ ì—°ìŠµ - íƒ€ì„ì–´íƒ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; text-align: center; background: #f4f7f6; padding: 20px; margin: 0; box-sizing: border-box;}
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        h1 { color: #2d3436; margin-bottom: 5px; }
        .sub-title { color: #636e72; font-size: 14px; margin-bottom: 20px; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: #dfe6e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; align-items: center;}
        select, input { padding: 8px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { border: none; border-radius: 5px; cursor: pointer; font-weight: bold; padding: 10px 15px; transition: 0.2s; }
        .home-btn { background: #636e72; color: white; margin-right: 10px;} /* í™ˆ ë²„íŠ¼ */
        .home-btn:hover { background: #2d3436; }
        .move-btn { background: #0984e3; color: white; } /* ì´ë™ ë²„íŠ¼ */
        .move-btn:hover { background: #0077c8; }

        /* ì •ë‹µ ë‹¨ì–´ */
        .target-box { margin: 20px 0; }
        .target-word { font-size: 28px; font-weight: bold; background: #2d3436; color: #2d3436; padding: 5px 20px; border-radius: 8px; cursor: pointer; user-select: none; transition: 0.3s; }
        .target-word:hover { color: white; background: #2d3436; }

        /* ë¬¸ì œ ë³´ë“œ */
        .problem-board { margin: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .row-box { display: flex; justify-content: center; align-items: center; gap: 10px; width: 100%; max-width: 400px; background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #eee;}
        .num-badge { color: #b2bec3; font-weight: bold; width: 20px; }
        .veg-box { width: 80px; padding: 8px 0; font-weight: bold; color: white; border-radius: 6px; font-size: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* ì±„ì†Œ ìƒ‰ìƒ */
        .bg-ê°€ì§€ { background-color: #6c5ce7; }
        .bg-ë²„ì„¯ { background-color: #a29bfe; }
        .bg-ë§ˆëŠ˜ { background-color: #636e72; }
        .bg-ë°”ë‚˜ë‚˜ { background-color: #ffeaa7; color: #d35400; }
        .bg-ì‚¬ê³¼ { background-color: #ff7675; }

        /* ì…ë ¥ì°½ */
        .input-section { margin-top: 30px; background: #f1f2f6; padding: 20px; border-radius: 10px; }
        .answer-input { width: 80%; padding: 15px; font-size: 20px; text-align: center; border: 2px solid #dfe6e9; border-radius: 10px; outline: none; transition: 0.3s; }
        .answer-input:focus { border-color: #0984e3; background: white; }
        .msg { margin-top: 15px; font-weight: bold; white-space: pre-line; min-height: 40px; font-size: 15px; line-height: 1.6;}

        /* ë¦¬ë”ë³´ë“œ */
        .leaderboard { margin-top: 40px; text-align: left; border-top: 2px solid #eee; padding-top: 20px; }
        .rank-list { max-height: 300px; overflow-y: auto; }
        .rank-item { padding: 10px; border-bottom: 1px solid #f1f1f1; font-size: 14px; display: flex; justify-content: space-between;}
        .rank-1 { color: #d63031; font-weight: bold; background: #fff0f0; }
        .rank-time { color: #0984e3; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: left; margin-bottom: 10px;">
        <button class="home-btn" onclick="location.href='index.html'">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <h1><ì—­ìŒê·¼ ì—°ìŠµ></h1>
    <div class="sub-title">í‘œì¤€êµ­ì–´ëŒ€ì‚¬ì „ 2ê¸€ì ì±Œë¦°ì§€ (íƒ€ì„ì–´íƒ)</div>
    
    <div class="control-panel">
        <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" style="width: 100px;">
        <select id="level-select" onchange="loadProblemList()">
            <option value="lv1">LEVEL 1 (3ì¤„)</option>
            <option value="lv2">LEVEL 2 (4ì¤„)</option>
            <option value="lv3">LEVEL 3 (5ì¤„)</option>
            <option value="lv4">LEVEL 4 (6ì¤„)</option>
            <option value="lv5">LEVEL 5 (7ì¤„)</option>
            <option value="lv6">LEVEL 6 (8ì¤„)</option>
            <option value="lv7">LEVEL 7 (9ì¤„)</option>
            <option value="lv8">LEVEL 8 (10ì¤„)</option>
        </select>
        <select id="q-select" onchange="loadGame()">
            </select>
        <button class="move-btn" onclick="loadGame()">ë¬¸ì œ ì´ë™</button>
    </div>

    <div class="target-box">
        <div>ì •ë‹µ ë‹¨ì–´ (ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë³´ì„)</div>
        <span id="target-display" class="target-word">??</span>
    </div>

    <div id="game-board" class="problem-board">
        </div>

    <div class="input-section">
        <input type="text" id="user-answer" class="answer-input" placeholder="ì •ë‹µ ì…ë ¥ (ì˜ˆ: ê°€êµ¬ ë‚˜ë¹„ ë‹¤ë¦¬)" onkeydown="if(event.key === 'Enter') checkAnswer()">
        <div id="status-msg" class="msg">ê²Œì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="leaderboard">
        <h3>ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹ (Fastest)</h3>
        <div id="rank-list" class="rank-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
        authDomain: "bsar5-d7818.firebaseapp.com",
        databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
        projectId: "bsar5-d7818",
        storageBucket: "bsar5-d7818.firebasestorage.app",
        messagingSenderId: "377629207721",
        appId: "1:377629207721:web:8b893496c0ac1749890db8",
        measurementId: "G-M9FJXYTS3F"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dictionary = new Set();
    let currentProblem = null;
    let currentLevel = "lv1";
    let currentQIdx = 0;
    
    // íƒ€ì„ì–´íƒìš© ë³€ìˆ˜
    let startTime = 0;

    window.onload = async function() {
        document.getElementById('status-msg').innerText = "ì‚¬ì „ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...";
        const snap = await db.ref('dictionary').once('value');
        if (snap.exists()) {
            dictionary = new Set(snap.val());
            document.getElementById('status-msg').innerText = "ì¤€ë¹„ ì™„ë£Œ! ë‹‰ë„¤ì„ì„ ì“°ê³  ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        } else {
            document.getElementById('status-msg').innerText = "âš ï¸ DBì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
            document.getElementById('status-msg').style.color = "red";
        }
        loadProblemList();
    };

    function loadProblemList() {
        const sel = document.getElementById('q-select');
        sel.innerHTML = "";
        for(let i=1; i<=20; i++) {
            let opt = document.createElement('option');
            opt.value = i-1;
            opt.text = `ë¬¸ì œ ${i}`;
            sel.appendChild(opt);
        }
        loadGame();
    }

    function loadGame() {
        currentLevel = document.getElementById('level-select').value;
        currentQIdx = document.getElementById('q-select').value;
        
        document.getElementById('user-answer').value = "";
        document.getElementById('user-answer').disabled = false;
        document.getElementById('status-msg').innerText = "";
        document.getElementById('status-msg').style.color = "black";
        document.getElementById('game-board').innerHTML = "ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

        // ë¦¬ë”ë³´ë“œ ë¨¼ì € ë¡œë“œ
        loadLeaderboard();

        db.ref(`problems/${currentLevel}/${currentQIdx}`).once('value').then(snap => {
            currentProblem = snap.val();
            if(!currentProblem) {
                document.getElementById('game-board').innerHTML = "ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            document.getElementById('target-display').innerText = currentProblem.target;
            const board = document.getElementById('game-board');
            board.innerHTML = "";
            
            currentProblem.pairs.forEach((pair, idx) => {
                const row = document.createElement('div');
                row.className = 'row-box';
                row.innerHTML = `
                    <span class="num-badge">${idx+1}</span>
                    <div class="veg-box bg-${pair.v1}">${pair.v1}</div>
                    <div class="veg-box bg-${pair.v2}">${pair.v2}</div>
                `;
                board.appendChild(row);
            });

            // â˜… ê²Œì„ ì‹œì‘ ì‹œê°„ ê¸°ë¡ â˜…
            startTime = Date.now();
        });
    }

    // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (ë°€ë¦¬ì´ˆ -> 0ë¶„ 00ì´ˆ 00)
    function formatTime(ms) {
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const centiseconds = Math.floor((ms % 1000) / 10); // 10ms ë‹¨ìœ„

        const fSec = seconds < 10 ? `0${seconds}` : seconds;
        const fCent = centiseconds < 10 ? `0${centiseconds}` : centiseconds;

        return `${minutes}ë¶„ ${fSec}ì´ˆ ${fCent}`;
    }

    // ìëª¨ ë¶„í•´ ë° ê·œì¹™ ì²´í¬ ë¡œì§ì€ ê¸°ì¡´ ìœ ì§€
    const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    const JUNG = ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
    const JONG = ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    const SPLIT = {
        'ã…˜':['ã…—','ã…'], 'ã…™':['ã…—','ã…'], 'ã…š':['ã…—','ã…£'], 'ã…':['ã…œ','ã…“'], 'ã…':['ã…œ','ã…”'], 'ã…Ÿ':['ã…œ','ã…£'], 'ã…¢':['ã…¡','ã…£'],
        'ã„³':['ã„±','ã……'], 'ã„µ':['ã„´','ã…ˆ'], 'ã„¶':['ã„´','ã…'], 'ã„º':['ã„¹','ã„±'], 'ã„»':['ã„¹','ã…'], 'ã„¼':['ã„¹','ã…‚'], 
        'ã„½':['ã„¹','ã……'], 'ã„¾':['ã„¹','ã…Œ'], 'ã„¿':['ã„¹','ã…'], 'ã…€':['ã„¹','ã…'], 'ã…„':['ã…‚','ã……']
    };

    function getComp(char) {
        if(!char) return {cho:'', all:new Set()};
        const c = char.charCodeAt(0) - 44032;
        if(c<0 || c>11171) return {cho:char, all:new Set([char])};

        const cho = CHO[Math.floor(c/588)];
        const jung = JUNG[Math.floor((c%588)/28)];
        const jong = JONG[c%28];

        let set = new Set();
        set.add(cho);
        if(SPLIT[jung]) SPLIT[jung].forEach(x=>set.add(x)); else set.add(jung);
        if(jong !== "") { if(SPLIT[jong]) SPLIT[jong].forEach(x=>set.add(x)); else set.add(jong); }
        return { cho: cho, all: set };
    }

    function checkRule(rule, inpC, tgtC, oppC) {
        const i = getComp(inpC);
        const t = getComp(tgtC);
        const o = getComp(oppC);
        let match = 0;
        i.all.forEach(x => { if(t.all.has(x)) match++; });

        if(rule === "ë²„ì„¯") return (i.cho === t.cho && match >= 2);
        if(rule === "ë§ˆëŠ˜") return (i.cho !== t.cho && match >= 2);
        if(rule === "ê°€ì§€") return (match === 1);
        if(rule === "ì‚¬ê³¼") return (match === 0);
        if(rule === "ë°”ë‚˜ë‚˜") {
            let oppMatch = 0;
            i.all.forEach(x => { if(o.all.has(x)) oppMatch++; });
            return (match === 0 && oppMatch >= 1);
        }
        return false;
    }

    function checkAnswer() {
        const nick = document.getElementById('nickname').value.trim();
        if(!nick) { alert("ë‹‰ë„¤ì„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
        // ë‹‰ë„¤ì„ì— ., #, $, [, ] ë“± íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ë˜ë©´ firebase keyë¡œ ì“¸ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ê°„ë‹¨ ì²˜ë¦¬
        if(/[.#$\[\]]/.test(nick)) { alert("ë‹‰ë„¤ì„ì— íŠ¹ìˆ˜ë¬¸ì(., #, $, [, ])ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

        const inputRaw = document.getElementById('user-answer').value.trim();
        const inputs = inputRaw.split(/\s+/);
        const status = document.getElementById('status-msg');
        
        if(inputs.length !== currentProblem.pairs.length) {
            status.innerText = `âŒ ë‹¨ì–´ ê°œìˆ˜ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
            status.style.color = "#d63031";
            return;
        }
        if(new Set(inputs).size !== inputs.length) {
            status.innerText = "âŒ ì¤‘ë³µëœ ë‹¨ì–´ê°€ ìˆìŠµë‹ˆë‹¤.";
            status.style.color = "#d63031";
            return;
        }

        let logs = "";
        let pass = true;
        const target = currentProblem.target;

        for(let i=0; i<inputs.length; i++) {
            const word = inputs[i];
            if(!dictionary.has(word)) { logs += `'${word}'ëŠ” ì‚¬ì „ì— ì—†ìŠµë‹ˆë‹¤.\n`; pass = false; continue; }
            const p = currentProblem.pairs[i];
            const r1 = checkRule(p.v1, word[0], target[0], target[1]);
            const r2 = checkRule(p.v2, word[1], target[1], target[0]);
            if(!r1 || !r2) { logs += `'${word}' ì˜¤ë‹µ\n`; pass = false; }
        }

        if(pass) {
            // â˜… ì¢…ë£Œ ì‹œê°„ ê³„ì‚° â˜…
            const endTime = Date.now();
            const elapsed = endTime - startTime;
            const timeStr = formatTime(elapsed);

            status.innerText = `ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!! (${timeStr})`;
            status.style.color = "#0984e3";
            document.getElementById('user-answer').disabled = true;
            
            // ê¸°ë¡ ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ (ë°€ë¦¬ì´ˆ, ë¬¸ìì—´)
            saveRecord(nick, elapsed, timeStr);
        } else {
            status.innerText = "âŒ ì˜¤ë‹µì…ë‹ˆë‹¤:\n" + logs;
            status.style.color = "#d63031";
        }
    }

    function saveRecord(nick, elapsedMs, displayTime) {
        // ê¸°ì¡´: pushë¡œ ë¬´ì¡°ê±´ ì¶”ê°€ -> ë³€ê²½: ë‹‰ë„¤ì„ ê¸°ì¤€ ê°±ì‹ 
        const path = `leaderboard/${currentLevel}/${currentQIdx}/${nick}`;
        
        db.ref(path).once('value').then(snap => {
            const data = snap.val();
            // ê¸°ë¡ì´ ì—†ê±°ë‚˜, ìƒˆë¡œìš´ ê¸°ë¡ì´ ë” ë¹ ë¥¼(ì‘ì„) ê²½ìš° ì €ì¥
            if (!data || elapsedMs < data.recordMs) {
                db.ref(path).set({
                    nickname: nick,
                    recordMs: elapsedMs, // ì •ë ¬ìš© ìˆ«ì
                    displayTime: displayTime, // í‘œì‹œìš© ë¬¸ìì—´
                    timestamp: Date.now()
                }).then(() => {
                    // ì €ì¥ í›„ ì•Œë¦¼ì€ ì„ íƒì‚¬í•­ (ì—¬ê¸°ì„  ìƒëµí•˜ê³  ë¦¬ë”ë³´ë“œ ê°±ì‹ )
                    // alert("ì‹ ê¸°ë¡ ê°±ì‹ !"); 
                });
            } else {
                // ê¸°ì¡´ ê¸°ë¡ì´ ë” ì¢‹ì€ ê²½ìš° (ì•„ë¬´ê²ƒë„ ì•ˆ í•˜ê±°ë‚˜ ë©”ì‹œì§€ í‘œì‹œ)
                // console.log("ê¸°ì¡´ ê¸°ë¡ì´ ë” ì¢‹ìŠµë‹ˆë‹¤.");
            }
        });
    }

    function loadLeaderboard() {
        const list = document.getElementById('rank-list');
        list.innerHTML = "ë¡œë”© ì¤‘...";
        
        // recordMs ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ì‘ì€ ì‹œê°„ì´ 1ë“±)
        const path = `leaderboard/${currentLevel}/${currentQIdx}`;
        
        db.ref(path).orderByChild('recordMs').limitToFirst(30).on('value', snap => {
            list.innerHTML = "";
            const records = [];
            
            snap.forEach(child => {
                records.push(child.val());
            });

            if(records.length === 0) {
                list.innerHTML = "<div style='padding:10px; color:#999;'>ì•„ì§ ì •ë‹µìê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; 
                return; 
            }

            records.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `rank-item ${idx===0?'rank-1':''}`;
                div.innerHTML = `
                    <span>${idx+1}ìœ„ : <b>${item.nickname}</b></span>
                    <span class="rank-time">${item.displayTime}</span>
                `;
                list.appendChild(div);
            });
        });
    }
</script>

</body>
</html>
