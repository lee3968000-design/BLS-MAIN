<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¼ìš©ëŸ‰ ë§ì¶”ê¸° ê²Œì„</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f4f4f9; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .dashboard { margin-top: 30px; padding: 15px; background: #e2e8f0; border-radius: 8px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        button { padding: 10px 15px; border: none; background: #00cec9; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #00b8b2; }
        .danger-btn { background: #ff7675; }
        .danger-btn:hover { background: #d63031; }
        .move-btn { background: #6c5ce7; }
        .move-btn:hover { background: #4834d4; }
        #userInputDisplay { width: 100%; height: 100px; margin-top: 15px; font-size: 14px; padding: 10px; box-sizing: border-box; background: #edf2f7; border: 2px solid #cbd5e0; resize: none; }
        .problem-info { background: #fffaf0; padding: 15px; border-left: 5px solid #fdcb6e; margin-bottom: 20px; }
        .top-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .leaderboard-item { margin-bottom: 5px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’§ ë¬¼ìš©ëŸ‰ ë§ì¶”ê¸° í›ˆë ¨ì†Œ</h2>
    <a href="index.html" style="display:inline-block; margin-bottom:15px; color:#6c5ce7; text-decoration:none; font-weight:bold;">â¬…ï¸ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    
    <div class="top-controls">
        <select id="levelSelect" onchange="updateProblemList()">
            <option value="lvl1">ë‚œì´ë„ í•˜ (ë¬¼í†µ 3ê°œ)</option>
            <option value="lvl2">ë‚œì´ë„ ìƒ (ë¬¼í†µ 3~4ê°œ)</option>
            <option value="lvl3">ë‚œì´ë„ í•˜ (ë¬¼í†µ 4ê°œ)</option>
        </select>
        <select id="problemSelect"></select>
        <button onclick="startProblem()">ë„ì „ ì‹œì‘</button>
        <button onclick="nextProblem()" style="background:#0984e3;">ë‹¤ìŒ ë¬¸ì œ â”</button>
    </div>

    <div class="problem-info" id="problemArea" style="display:none;">
        <h3 id="problemTitle"></h3>
        <p><strong>ì´ˆê¸° ìƒíƒœ:</strong> <span id="initialState" style="color:#0984e3; font-weight:bold;"></span></p>
        <p style="font-size: 1.2rem; color: #d63031;"><strong>ë¯¸ì…˜:</strong> <span id="missionText"></span></p>
        <p><strong>ì œí•œ íšŸìˆ˜:</strong> <span id="maxMoves"></span>íšŒ (í˜„ì¬ <span id="currentMoves">0</span>íšŒ ì…ë ¥í•¨)</p>
        <h3>â±ï¸ ì†Œìš” ì‹œê°„: <span id="timer">0.0</span>ì´ˆ</h3>
    </div>

    <div id="gameArea" style="display:none;">
        <textarea id="userInputDisplay" readonly placeholder="ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í–‰ë™ì´ ìˆœì„œëŒ€ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤..."></textarea>
        
        <div class="btn-group" id="actionButtons"></div>

        <div class="btn-group" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 15px;">
            <button onclick="submitSolution()" style="background: #00b894; width: 100%; font-size: 1.1rem; padding: 15px;">âœ… ì •ë‹µ ì œì¶œí•˜ê¸° (Enter)</button>
            <button class="danger-btn" onclick="resetInput()" style="width: 100%;">ì…ë ¥ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="dashboard">
        <h3>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (í˜„ì¬ ë¬¸ì œ)</h3>
        <ul id="leaderboardList" style="list-style: none; padding: 0;">
            <li>ë¬¸ì œë¥¼ ì„ íƒí•˜ë©´ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</li>
        </ul>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // ì‚¬ìš©ìê°€ ì œê³µí•œ Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
        authDomain: "bsar5-d7818.firebaseapp.com",
        databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
        projectId: "bsar5-d7818",
        storageBucket: "bsar5-d7818.firebasestorage.app",
        messagingSenderId: "377629207721",
        appId: "1:377629207721:web:8b893496c0ac1749890db8",
        measurementId: "G-M9FJXYTS3F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ì „ì—­ ë³€ìˆ˜ë¡œ í• ë‹¹í•˜ì—¬ ì¼ë°˜ script íƒœê·¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•¨
    window.db = db;
    window.dbRef = ref;
    window.dbPush = push;
    window.dbOnValue = onValue;
    window.dbQuery = query;
    window.dbOrderByChild = orderByChild;
</script>

<script>
    let problemDB = {};
    let currentProblem = null;
    let userInputSequence = [];
    let startTime = 0;
    let timerInterval = null;

    // 1. problems.json íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch('problems.json')
        .then(response => response.json())
        .then(data => {
            problemDB = data;
            updateProblemList();
        })
        .catch(error => {
            console.error('Error loading JSON:', error);
            alert("problems.json íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
        });

    // 2. ë¬¸ì œ ëª©ë¡ ì—…ë°ì´íŠ¸
    window.updateProblemList = function() {
        const level = document.getElementById("levelSelect").value;
        const pSelect = document.getElementById("problemSelect");
        pSelect.innerHTML = "";
        
        if(problemDB[level]) {
            problemDB[level].forEach((p, index) => {
                const opt = document.createElement("option");
                opt.value = index;
                opt.innerText = p.title;
                pSelect.appendChild(opt);
            });
        }
    }

    // 3. ë¬¸ì œ ì‹œì‘ ì…‹íŒ…
    window.startProblem = function() {
        const level = document.getElementById("levelSelect").value;
        const pIndex = document.getElementById("problemSelect").value;
        currentProblem = problemDB[level][pIndex];
        
        document.getElementById("problemArea").style.display = "block";
        document.getElementById("gameArea").style.display = "block";
        document.getElementById("problemTitle").innerText = currentProblem.title;
        
        let initialStateStr = "";
        for(let key in currentProblem.jugs) {
            initialStateStr += `[${key}ë¬¼í†µ: ${currentProblem.jugs[key].current}/${currentProblem.jugs[key].max}L] `;
        }
        document.getElementById("initialState").innerText = initialStateStr;
        document.getElementById("missionText").innerText = `${currentProblem.goal.jug}ë¬¼í†µì— ì •í™•íˆ ${currentProblem.goal.amount}L ì˜ ë¬¼ì„ ë§Œë“œì„¸ìš”!`;
        document.getElementById("maxMoves").innerText = currentProblem.maxMoves;
        
        resetInput();
        generateActionButtons();
        startTimer();
        loadLeaderboard(); 
    }

    window.nextProblem = function() {
        const pSelect = document.getElementById("problemSelect");
        if(pSelect.selectedIndex < pSelect.options.length - 1) {
            pSelect.selectedIndex += 1;
            startProblem();
        } else {
            alert("ì´ ë‚œì´ë„ì˜ ë§ˆì§€ë§‰ ë¬¸ì œì…ë‹ˆë‹¤!");
        }
    }

    // 4. ë™ì  ë²„íŠ¼ ìƒì„±
    function generateActionButtons() {
        const btnArea = document.getElementById("actionButtons");
        btnArea.innerHTML = "";
        const jugs = Object.keys(currentProblem.jugs);

        jugs.forEach(jug => {
            btnArea.innerHTML += `<button onclick="addAction('FILL_${jug}', '${jug} ì™„ì „íˆ ì±„ìš°ê¸°')">${jug} ì±„ìš°ê¸°</button>`;
            btnArea.innerHTML += `<button class="danger-btn" onclick="addAction('EMPTY_${jug}', '${jug} ì™„ì „íˆ ë¹„ìš°ê¸°')">${jug} ë¹„ìš°ê¸°</button>`;
        });

        jugs.forEach(fromJug => {
            jugs.forEach(toJug => {
                if(fromJug !== toJug) {
                    btnArea.innerHTML += `<button class="move-btn" onclick="addAction('MOVE_${fromJug}_${toJug}', '${fromJug}ì—ì„œ ${toJug}(ìœ¼)ë¡œ ìµœëŒ€í•œ ì˜®ê¸°ê¸°')">${fromJug} â” ${toJug}</button>`;
                }
            });
        });
    }

    // 5. ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
    window.addAction = function(actionCode, displayWord) {
        if(userInputSequence.length >= currentProblem.maxMoves) {
            alert(`ì œí•œ íšŸìˆ˜(${currentProblem.maxMoves}íšŒ)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`);
            return;
        }
        userInputSequence.push({ code: actionCode, word: displayWord });
        updateInputDisplay();
    }

    function updateInputDisplay() {
        const displayArr = userInputSequence.map((act, index) => `${index + 1}. ${act.word}`);
        document.getElementById("userInputDisplay").value = displayArr.join("\n");
        document.getElementById("currentMoves").innerText = userInputSequence.length;
    }

    window.resetInput = function() {
        userInputSequence = [];
        updateInputDisplay();
    }

    // 6. íƒ€ì´ë¨¸
    function startTimer() {
        clearInterval(timerInterval);
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsedTime = (Date.now() - startTime) / 1000;
            document.getElementById("timer").innerText = elapsedTime.toFixed(1);
        }, 100);
    }

    // ì—”í„°í‚¤ ì œì¶œ
    document.getElementById("userInputDisplay").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            submitSolution();
        }
    });

    // 7. ì±„ì  ì‹œë®¬ë ˆì´í„° ë¡œì§
    window.submitSolution = function() {
        if(!currentProblem) return;

        // ê°€ìƒ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´ í˜„ì¬ ìƒíƒœ ë³µì‚¬
        let simJugs = JSON.parse(JSON.stringify(currentProblem.jugs));
        
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìˆœì„œëŒ€ë¡œ ë¡œì§ ì‹¤í–‰
        for(let action of userInputSequence) {
            let parts = action.code.split('_');
            let type = parts[0]; 
            
            if(type === 'FILL') {
                simJugs[parts[1]].current = simJugs[parts[1]].max;
            }
            else if(type === 'EMPTY') {
                simJugs[parts[1]].current = 0;
            }
            else if(type === 'MOVE') {
                let from = parts[1], to = parts[2];
                let moveAmount = Math.min(simJugs[from].current, simJugs[to].max - simJugs[to].current);
                simJugs[from].current -= moveAmount;
                simJugs[to].current += moveAmount;
            }
        }

        // ê²°ê³¼ ê²€ì¦
        if(simJugs[currentProblem.goal.jug].current === currentProblem.goal.amount) {
            clearInterval(timerInterval);
            const finalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            alert(`ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ì†Œìš” ì‹œê°„: ${finalTime}ì´ˆ`);
            saveRecordToFirebase(finalTime);
        } else {
            alert("âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì œì¶œí•˜ì‹  ìˆœì„œëŒ€ë¡œ ìˆ˜í–‰í•´ë³´ì•˜ì§€ë§Œ ëª©í‘œ ìš©ëŸ‰ì´ ë‹¬ì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    }

    // 8. Firebase ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸°
    function saveRecordToFirebase(time) {
        let userName = prompt("ì¶•í•˜í•©ë‹ˆë‹¤! ëª…ì˜ˆì˜ ì „ë‹¹ì— ë“±ë¡í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìµëª…");
        if(userName === null) return; 
        if(userName.trim() === "") userName = "ìµëª…";

        const recordRef = window.dbRef(window.db, 'waterjug_leaderboard/' + currentProblem.id);
        window.dbPush(recordRef, {
            name: userName,
            time: parseFloat(time),
            moves: userInputSequence.length,
            timestamp: Date.now()
        }).then(() => {
            // ì €ì¥ ì„±ê³µ í›„ ì´ˆê¸°í™”
            resetInput();
        }).catch(error => {
            console.error("Firebase ì €ì¥ ì˜¤ë¥˜:", error);
            alert("ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    function loadLeaderboard() {
        const recordRef = window.dbRef(window.db, 'waterjug_leaderboard/' + currentProblem.id);
        const topScores = window.dbQuery(recordRef, window.dbOrderByChild('time'));

        window.dbOnValue(topScores, (snapshot) => {
            const list = document.getElementById("leaderboardList");
            list.innerHTML = "";
            
            if(snapshot.exists()) {
                let rank = 1;
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    list.innerHTML += `<li class="leaderboard-item">
                        <strong style="color:#e17055;">${rank}ìœ„: ${data.time}ì´ˆ</strong> | ${data.name} (ì´ë™ íšŸìˆ˜: ${data.moves}íšŒ)
                    </li>`;
                    rank++;
                });
            } else {
                list.innerHTML = "<li class='leaderboard-item'>ì•„ì§ ì´ ë¬¸ì œë¥¼ í‘¼ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸°ë¡ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</li>";
            }
        });
    }
</script>

</body>
</html>
