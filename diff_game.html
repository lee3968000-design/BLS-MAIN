<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒ‰ê¹” ë³€í™” ì¹´ìš´íŒ…</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ë°” */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #eee; border-radius: 10px; flex-wrap: wrap; gap: 10px;}
        .home-btn { background: #636e72; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .home-btn:hover { background: #2d3436; }
        
        .control-group { display: flex; gap: 5px; align-items: center; }
        select, input { padding: 10px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
        
        .btn-move { padding:10px 15px; background:#00b894; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        .btn-move:hover { background: #00a383; }
        .btn-next { padding:10px 15px; background:#0984e3; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin-left: 5px;}
        .btn-next:hover { background: #0077c8; }
        
        .timer { font-weight: bold; font-size: 20px; color: #d63031; min-width: 80px; text-align: right;}

        /* ê²Œì„ ì˜ì—­ */
        .game-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; margin-bottom: 20px; }
        
        .board-container { text-align: center; }
        .board-label { font-weight: bold; margin-bottom: 10px; font-size: 18px; color: #333; }
        
        /* ê·¸ë¦¬ë“œ ë™ì  ìƒì„± */
        .grid { 
            display: grid; 
            gap: 2px; /* ì¹¸ ì‚¬ì´ ê°„ê²© */
            background-color: #333; /* í…Œë‘ë¦¬ ì—­í•  */
            border: 2px solid #333; 
            padding: 2px;
        }

        .cell {
            width: 50px;
            height: 50px;
            border: 1px solid rgba(0,0,0,0.1); /* ë‚´ë¶€ ë¯¸ì„¸ í…Œë‘ë¦¬ */
        }

        /* ì…ë ¥ ë° ê²°ê³¼ */
        .input-section { margin-top: 20px; padding: 20px; background: #fafafa; border-radius: 10px; }
        .answer-input { width: 150px; padding: 10px; font-size: 18px; text-align: center; }
        .feedback { margin-top: 10px; font-weight: bold; font-size: 18px; min-height: 30px; }

        /* ë¦¬ë”ë³´ë“œ */
        .leaderboard { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 10px; max-width: 600px; margin-left: auto; margin-right: auto;}
        .rank-list { max-height: 200px; overflow-y: auto; text-align: left; }
        .rank-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .rank-1 { color: #d63031; font-weight: bold; background: #fff0f0; }
        
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <button class="home-btn" onclick="location.href='index.html'">ğŸ  í™ˆìœ¼ë¡œ</button>
        
        <div class="control-group">
            <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" style="width: 80px;">
            
            <select id="level-select" onchange="updateProblemSelect()">
                <option value="lv1">1ë‹¨ê³„ (4x4)</option>
                <option value="lv2">2ë‹¨ê³„ (4x5)</option>
                <option value="lv3">3ë‹¨ê³„ (5x5)</option>
                <option value="lv4">4ë‹¨ê³„ (5x6)</option>
                <option value="lv5">5ë‹¨ê³„ (6x6)</option>
            </select>

            <select id="prob-select">
                </select>
            
            <button class="btn-move" onclick="startGame()">ì´ë™</button>
            <button class="btn-next" onclick="nextProblem()">ë‹¤ìŒ ë¬¸ì œ â–¶</button>
        </div>
        
        <div id="timer-display" class="timer">0.00ì´ˆ</div>
    </div>

    <h1>ğŸ¨ ìƒ‰ê¹” ë³€í™” ì¹´ìš´íŒ…</h1>
    <p style="color:#666; font-size:14px;">ì™¼ìª½ê³¼ ì˜¤ë¥¸ìª½ì„ ë¹„êµí•´ì„œ ìƒ‰ê¹”ì´ ë°”ë€ ì¹¸ì˜ ê°œìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>

    <div class="game-area">
        <div class="board-container">
            <div class="board-label">ê¸°ì¤€ íŒ</div>
            <div id="grid1" class="grid"></div>
        </div>
        <div class="board-container">
            <div class="board-label">ë¬¸ì œ íŒ</div>
            <div id="grid2" class="grid"></div>
        </div>
    </div>

    <div class="input-section">
        <span>ë°”ë€ ì¹¸ì˜ ê°œìˆ˜ëŠ”? </span>
        <input type="number" id="user-answer" class="answer-input" placeholder="ìˆ«ì ì…ë ¥" onkeydown="if(event.key === 'Enter') checkAnswer()" disabled>
        <div id="feedback-msg" class="feedback"></div>
    </div>

    <div class="leaderboard">
        <div id="rank-title" style="font-weight:bold; margin-bottom:10px;">ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹</div>
        <div id="rank-list" class="rank-list">ë°ì´í„° ë¡œë”© ì¤‘...</div>
    </div>
</div>

<script>
    // ==========================================
    // [ì„¤ì •] ì‚¬ìš©ì ì •ë³´ ì ìš© ì™„ë£Œ
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
        authDomain: "bsar5-d7818.firebaseapp.com",
        databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
        projectId: "bsar5-d7818",
        storageBucket: "bsar5-d7818.firebasestorage.app",
        messagingSenderId: "377629207721",
        appId: "1:377629207721:web:8b893496c0ac1749890db8",
        measurementId: "G-M9FJXYTS3F"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ìƒ‰ìƒ ë§¤í•‘
    const COLOR_MAP = {
        "ë¹¨ê°•": "#ff7675", "ë…¸ë‘": "#ffeaa7", "íŒŒë‘": "#0984e3", 
        "ì´ˆë¡": "#55efc4", "íšŒìƒ‰": "#b2bec3", "ê²€ì •": "#2d3436", "ê°ˆìƒ‰": "#a0522d"
    };

    let allData = {}; 
    let currentLevel = "lv1";
    let currentIdx = 0;
    let currentProblem = null;
    let startTime = 0;
    let timerInterval = null;
    let rankListener = null;

    window.onload = function() {
        loadData();
    };

    // 1. ë°ì´í„° ë¡œë“œ
    function loadData() {
        const msg = document.getElementById('feedback-msg');
        msg.innerText = "ë°ì´í„° ë¡œë”© ì¤‘...";
        
        // ì—…ë¡œë”ë¡œ ì˜¬ë¦° diff_problems ê²½ë¡œì—ì„œ ê°€ì ¸ì˜´
        db.ref('diff_problems').once('value').then(snap => {
            allData = snap.val();
            if(!allData) {
                msg.innerText = "âš ï¸ DBì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. (diff_uploader.html ì‹¤í–‰ í•„ìš”)";
                msg.style.color = "red";
                return;
            }
            // ë¬¸ì œ ì„ íƒë°•ìŠ¤ ì´ˆê¸°í™”
            updateProblemSelect();
            msg.innerText = "ì¤€ë¹„ ì™„ë£Œ! ì´ë™ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.";
            
            // ìë™ ì‹œì‘
            startGame(); 
        });
    }

    // 2. ë ˆë²¨ ë³€ê²½ ì‹œ ë¬¸ì œ ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateProblemSelect() {
        const lvSelect = document.getElementById('level-select');
        const probSelect = document.getElementById('prob-select');
        currentLevel = lvSelect.value;
        
        probSelect.innerHTML = "";
        if(allData[currentLevel]) {
            allData[currentLevel].forEach((_, idx) => {
                let opt = document.createElement('option');
                opt.value = idx;
                opt.text = `ë¬¸ì œ ${idx + 1}`;
                probSelect.appendChild(opt);
            });
        }
    }

    // 3. ê²Œì„ ì‹œì‘
    function startGame() {
        const nick = document.getElementById('nickname').value.trim();
        const lvSelect = document.getElementById('level-select');
        const probSelect = document.getElementById('prob-select');
        
        if(!allData[currentLevel]) return;

        // ì„ íƒê°’ ì ìš©
        currentLevel = lvSelect.value;
        currentIdx = parseInt(probSelect.value);
        currentProblem = allData[currentLevel][currentIdx];

        // UI ì´ˆê¸°í™”
        const input = document.getElementById('user-answer');
        input.value = "";
        input.disabled = false;
        input.focus();
        document.getElementById('feedback-msg').innerText = "";

        // ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸°
        drawGrid('grid1', currentProblem.board1, currentProblem.rows, currentProblem.cols);
        drawGrid('grid2', currentProblem.board2, currentProblem.rows, currentProblem.cols);

        // íƒ€ì´ë¨¸ ì‹œì‘
        if(timerInterval) clearInterval(timerInterval);
        startTime = Date.now();
        timerInterval = setInterval(() => {
            document.getElementById('timer-display').innerText = ((Date.now() - startTime) / 1000).toFixed(2) + "ì´ˆ";
        }, 30);

        // ë¦¬ë”ë³´ë“œ ë¡œë“œ
        loadLeaderboard();
    }

    function drawGrid(elementId, boardData, rows, cols) {
        const grid = document.getElementById(elementId);
        grid.innerHTML = "";
        
        // CSS Grid í…œí”Œë¦¿ ì„¤ì •
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.style.width = `${cols * 50 + (cols-1)*2}px`; 

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                const colorName = boardData[r][c];
                cell.style.backgroundColor = COLOR_MAP[colorName] || colorName;
                grid.appendChild(cell);
            }
        }
    }

    // 4. ë‹¤ìŒ ë¬¸ì œ
    function nextProblem() {
        const probSelect = document.getElementById('prob-select');
        let nextIdx = currentIdx + 1;
        
        if (!allData[currentLevel][nextIdx]) {
            alert("í•´ë‹¹ ë‹¨ê³„ì˜ ë§ˆì§€ë§‰ ë¬¸ì œê¹Œì§€ í’€ì—ˆìŠµë‹ˆë‹¤!");
            return;
        }

        probSelect.value = nextIdx;
        startGame();
    }

    // 5. ì •ë‹µ í™•ì¸
    function checkAnswer() {
        const input = document.getElementById('user-answer');
        const feedback = document.getElementById('feedback-msg');
        const val = parseInt(input.value);

        if (isNaN(val) || val < 0) return;

        if (val === currentProblem.answer) {
            // ì •ë‹µ
            clearInterval(timerInterval);
            const clearTime = ((Date.now() - startTime) / 1000).toFixed(2);
            feedback.style.color = "#00b894";
            feedback.innerText = `ğŸ‰ ì •ë‹µ! (${clearTime}ì´ˆ)`;
            input.disabled = true;
            saveRecord(clearTime);
        } else {
            // ì˜¤ë‹µ
            feedback.style.color = "#d63031";
            feedback.innerText = `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ì„¸ì–´ë³´ì„¸ìš”!`;
            input.value = "";
        }
    }

    // 6. ê¸°ë¡ ì €ì¥
    function saveRecord(time) {
        const nick = document.getElementById('nickname').value;
        if(!nick) return; 

        db.ref(`diff_leaderboard/${currentLevel}/${currentIdx}`).push({
            nickname: nick,
            time: parseFloat(time),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // 7. ë¦¬ë”ë³´ë“œ ë¡œë“œ
    function loadLeaderboard() {
        const list = document.getElementById('rank-list');
        const title = document.getElementById('rank-title');
        title.innerText = `ğŸ… ëª…ì˜ˆì˜ ì „ë‹¹ [${currentLevel.toUpperCase()} - ë¬¸ì œ ${currentIdx + 1}]`;
        list.innerHTML = "ë¡œë”© ì¤‘...";

        if(rankListener) db.ref().off('value', rankListener);

        const query = db.ref(`diff_leaderboard/${currentLevel}/${currentIdx}`).orderByChild('time').limitToFirst(20);
        
        rankListener = query.on('value', snap => {
            list.innerHTML = "";
            const data = snap.val();
            if(!data) {
                list.innerHTML = "<div style='padding:10px; color:#999;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
                return;
            }

            let arr = [];
            snap.forEach(child => arr.push(child.val()));

            arr.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `rank-item ${idx===0?'rank-1':''}`;
                div.innerHTML = `
                    <span>${idx+1}ìœ„ <b>${item.nickname}</b></span>
                    <span style="font-weight:bold; color:${idx===0?'#d63031':'#0984e3'}">${item.time}ì´ˆ</span>
                `;
                list.appendChild(div);
            });
        });
    }
</script>

</body>
</html>