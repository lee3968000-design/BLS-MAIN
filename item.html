<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì´í…œì „ í†µí•© ê¸°ë¡ì‹¤</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f0f2f5; }
        h1 { text-align: center; color: #333; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
        select, button, input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #444; color: white; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #666; }
        button.save-btn { background-color: #007bff; border-color: #007bff; }
        button.save-btn:hover { background-color: #0056b3; }
        .home-btn { background-color: #333 !important; margin-right: 15px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; max-height: 80vh; }
        table { border-collapse: separate; border-spacing: 0; }
        
        /* ì…€ ìŠ¤íƒ€ì¼ */
        th, td { padding: 8px 5px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; border-right: 1px solid #eee; font-size: 0.9rem; }
        
        /* ì¢…ëª© ê°„ êµ¬ë¶„ì„  (êµµê²Œ) */
        .event-divider { border-right: 2px solid #999; }

        /* í—¤ë” ê³ ì • (2ë‹¨ êµ¬ì¡°) */
        thead { position: sticky; top: 0; z-index: 20; }
        th { background-color: #444; color: white; user-select: none; }
        
        /* 1ë‹¨ í—¤ë” (ì¢…ëª©ëª…) */
        .header-top th { background-color: #333; border-bottom: 1px solid #666; font-size: 1.1em; padding: 10px; }
        
        /* 2ë‹¨ í—¤ë” (ì„¸ë¶€í•­ëª©) */
        .header-sub th { background-color: #555; font-size: 0.8em; cursor: pointer; }
        .header-sub th:hover { background-color: #777; }

        /* ì´ë¦„ ì»¬ëŸ¼ ê³ ì • (Sticky) */
        .sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 30; 
            background-color: #fff; 
            border-right: 2px solid #333; /* ì´ë¦„ ì˜†ì€ ë” ì§„í•˜ê²Œ */
            font-weight: bold;
            min-width: 100px;
        }
        /* í—¤ë”ì˜ ì´ë¦„ ì»¬ëŸ¼ë„ ê³ ì • */
        .header-top .sticky-col { z-index: 40; background-color: #333; }
        .header-sub .sticky-col { z-index: 40; background-color: #555; }

        /* íŒ€ ìƒ‰ìƒ */
        .team-purple { border-left: 5px solid #800080; background-color: #fcf0fc; color: #800080; }
        .team-green { border-left: 5px solid #008000; background-color: #f0fcf0; color: #008000; }
        .team-yellow { border-left: 5px solid #DAA520; background-color: #fcfcf0; color: #DAA520; }
        .team-blue { border-left: 5px solid #0000FF; background-color: #f0f0fc; color: #0000FF; }
        .team-red { border-left: 5px solid #FF0000; background-color: #fcf0f0; color: #FF0000; }
        .team-brown { border-left: 5px solid #A52A2A; background-color: #fcf5f0; color: #A52A2A; }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        #adminPanel { display: none; border: 2px solid #444; padding: 20px; margin-top: 20px; background: #fff; border-radius: 8px; }
        .input-group { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>

    <h1>ğŸ° ì•„ì´í…œì „ í†µí•© ê¸°ë¡ì‹¤</h1>

    <div class="controls">
        <button onclick="location.href='index.html'" class="home-btn">ğŸ  í™ˆìœ¼ë¡œ</button>

        <label>ğŸ“… ì£¼ì°¨:</label>
        <select id="weekSelect" onchange="loadData()">
            <option value="item_week1">1ì£¼ì°¨</option>
            <option value="item_week2">2ì£¼ì°¨</option>
            <option value="item_week3">3ì£¼ì°¨</option>
            <option value="item_week4">4ì£¼ì°¨</option>
            <option value="item_week5">5ì£¼ì°¨</option>
        </select>

        <button onclick="toggleAdmin()">âš™ï¸ ê¸°ë¡ ì…ë ¥ (ê´€ë¦¬ì)</button>
    </div>

    <div class="table-container">
        <table id="recordTable">
            <thead id="tableHead">
                </thead>
            <tbody id="tableBody">
                <tr><td colspan="60" style="text-align:center; padding: 20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="adminPanel">
        <h3>ğŸ“ ê¸°ë¡ ì…ë ¥ íŒ¨ë„</h3>
        <div class="input-group">
            <select id="inputEventSelect">
                </select>
            <select id="inputNameSelect">
                <option value="">ì„ ìˆ˜ ì„ íƒ</option>
            </select>
        </div>
        <div class="input-group">
            <select id="inputMetricSelect" onchange="updatePlaceholder()">
                </select>
            <input type="text" id="inputRecord" placeholder="ê¸°ë¡ ì…ë ¥ (ì—”í„°ë¡œ ì €ì¥)" onkeydown="if(window.event.keyCode == 13){ saveRecord(); }">
            <button class="save-btn" onclick="saveRecord()">ì €ì¥</button>
        </div>
        <p style="font-size: 0.8em; color: gray;">
            * <b>ì‹œê°„(ì†Œìˆ˜ì )</b>: ìë™ .00 ì²˜ë¦¬ / <b>ë¬¸ì œìˆ˜(ì •ìˆ˜)</b>: ìˆ«ìë§Œ / <b>RETIRE</b>: ìë™ ëŒ€ë¬¸ì ë³€í™˜<br>
            * <b>ì„œí¬í„° ìš”ì •ì‹œê°„</b>: ê¸°ë¡ ì—†ì„ ì‹œ '-' ì…ë ¥ ê°€ëŠ¥
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âœ… [ì„¤ì • 1] ì•„ì´í…œì „ ì¢…ëª© 12ê°œ
        const eventNames = [
            "ë‹¨ì–´ì¡°í•©", "ì¹´í…Œê³ ë¦¬", "íŠ¸ëœìŠ¤ë ˆí„°", "ì¸ë¬¼í€´ì¦ˆ", 
            "ë‚˜ë¼í€´ì¦ˆ", "ìºì¹˜ë§ˆì¸ë“œ", "ìœ íŠœë¸Œ", "í•˜ì´ë¡œìš°", 
            "ì»¬ëŸ¬ ì²´ì¸ì§€", "í•œìˆ˜ì™„", "ë£°ë ›", "ì´ìƒí˜•"
        ];

        // âœ… [ì„¤ì • 2] 5ê°œ ì„¸ë¶€ í•­ëª© (ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ê°„ì†Œí™”)
        const metrics = [
            { key: "sw_prob", label: "ìŠ¤ìœ„í¼<br>ë¬¸ì œìˆ˜", type: "int" },
            { key: "sp_item", label: "ì„œí¬í„°<br>ì•„ì´í…œ", type: "text" },
            { key: "sp_fairy", label: "ì„œí¬í„°<br>ìš”ì •ì‹œê°„", type: "float_dash" },
            { key: "rn_time", label: "ëŸ¬ë„ˆ<br>ìµœì¢…ì‹œê°„", type: "float_retire" },
            { key: "rn_prob", label: "ëŸ¬ë„ˆ<br>ë¬¸ì œìˆ˜", type: "int" }
        ];

        // âœ… [ì„¤ì • 3] ì°¸ê°€ì ëª…ë‹¨
        const defaultPlayers = [
            { name: "GMT_ê³¼ë°•", team: "purple" }, { name: "GMT_ë‘ì›”", team: "purple" }, { name: "GMT_ìµëª…", team: "purple" }, { name: "GMT_ì°Œë†", team: "purple" }, { name: "GMT_í›„ì¥", team: "purple" },
            { name: "GS3_ê²Œë¡œ", team: "green" }, { name: "GS3_ì°½ì¡°", team: "green" }, { name: "GS3_ë„´ë¦¬", team: "green" }, { name: "GS3_ì§í”Œ", team: "green" }, { name: "GS3_ì„œì§„", team: "green" },
            { name: "B1A4_ìš´ëª…", team: "yellow" }, { name: "B1A4_ëŸ¬ê°", team: "yellow" }, { name: "B1A4_ì†Œë„¤", team: "yellow" }, { name: "B1A4_ìš°ìœ ", team: "yellow" }, { name: "B1A4_ì§‘ê°€", team: "yellow" },
            { name: "DBT_ëª¨ì§€", team: "blue" }, { name: "DBT_ë¡œë‹ˆ", team: "blue" }, { name: "DBT_ì‚¬ë¥´", team: "blue" }, { name: "DBT_ì§€ë‹ˆ", team: "blue" }, { name: "DBT_í‹°í‹°", team: "blue" },
            { name: "HTML_í•˜ë©œ", team: "red" }, { name: "HTML_ê·¤ê¹Œ", team: "red" }, { name: "HTML_ë¬´í˜¼", team: "red" }, { name: "HTML_í‘ë‘", team: "red" }, { name: "HTML_ì—˜ì œ", team: "red" },
            { name: "BLS_í•œë¹ˆ", team: "brown" }, { name: "BLS_ë„ê°", team: "brown" }, { name: "BLS_ë¬¸ìŠ¤", team: "brown" }, { name: "BLS_ë¸”ìŠ¤", team: "brown" }, { name: "BLS_ì„­ì¢€", team: "brown" }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8",
            measurementId: "G-M9FJXYTS3F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentData = [];
        let currentWeek = "item_week1";

        window.loadData = loadData;
        window.saveRecord = saveRecord;
        window.toggleAdmin = toggleAdmin;
        window.sortTable = sortTable;
        window.updatePlaceholder = updatePlaceholder;

        function initUI() {
            renderHeader();
            
            // 1. ì¢…ëª© ì„ íƒ ë“œë¡­ë‹¤ìš´ (ì…ë ¥ìš©)
            const eventSelect = document.getElementById('inputEventSelect');
            let eventOptions = "";
            eventNames.forEach((name, index) => {
                eventOptions += `<option value="event${index + 1}">${name}</option>`;
            });
            eventSelect.innerHTML = eventOptions;

            // 2. í•­ëª© ì„ íƒ ë“œë¡­ë‹¤ìš´
            const metricSelect = document.getElementById('inputMetricSelect');
            let metricOptions = "";
            metrics.forEach((m) => {
                metricOptions += `<option value="${m.key}" data-type="${m.type}">${m.label.replace('<br>',' ')}</option>`;
            });
            metricSelect.innerHTML = metricOptions;

            // 3. ì„ ìˆ˜ ì„ íƒ ë“œë¡­ë‹¤ìš´
            const nameSelect = document.getElementById('inputNameSelect');
            let nameOptions = `<option value="">ì„ ìˆ˜ ì„ íƒ</option>`;
            defaultPlayers.forEach(p => {
                nameOptions += `<option value="${p.name}">${p.name} (${p.team})</option>`;
            });
            nameSelect.innerHTML = nameOptions;
        }

        function renderHeader() {
            const thead = document.getElementById('tableHead');
            
            // 1ë‹¨ í—¤ë”: ì¢…ëª©ëª… (colspan=5)
            let row1 = `<tr class="header-top"><th class="sticky-col" rowspan="2">ì´ë¦„ (íŒ€)</th>`;
            eventNames.forEach((name, index) => {
                // ë§ˆì§€ë§‰ ì¢…ëª©ì´ ì•„ë‹ˆë©´ êµ¬ë¶„ì„  í´ë˜ìŠ¤ ì¶”ê°€
                const borderClass = (index < eventNames.length - 1) ? "event-divider" : "";
                row1 += `<th colspan="5" class="${borderClass}">${name}</th>`;
            });
            row1 += `</tr>`;

            // 2ë‹¨ í—¤ë”: ì„¸ë¶€ í•­ëª©
            let row2 = `<tr class="header-sub">`;
            eventNames.forEach((_, evIdx) => {
                metrics.forEach((m, mIdx) => {
                    const isLastMetric = (mIdx === metrics.length - 1);
                    const borderClass = (isLastMetric && evIdx < eventNames.length - 1) ? "event-divider" : "";
                    // ì •ë ¬ í‚¤: eventX_metricKey
                    const sortKey = `event${evIdx+1}_${m.key}`;
                    row2 += `<th class="${borderClass}" onclick="sortTable('${sortKey}')">${m.label}</th>`;
                });
            });
            row2 += `</tr>`;

            thead.innerHTML = row1 + row2;
        }

        function updatePlaceholder() {
            const select = document.getElementById('inputMetricSelect');
            const type = select.options[select.selectedIndex].dataset.type;
            const input = document.getElementById('inputRecord');
            
            if(type.includes('float')) input.placeholder = "ì‹œê°„ (ì˜ˆ: 12.34)";
            else if(type === 'int') input.placeholder = "ì •ìˆ˜ ìˆ«ìë§Œ";
            else input.placeholder = "í…ìŠ¤íŠ¸";
        }

        async function loadData() {
            currentWeek = document.getElementById('weekSelect').value;
            const tableBody = document.getElementById('tableBody');
            
            const dbRef = ref(db);
            // í•´ë‹¹ ì£¼ì°¨ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´ (event1 ~ event12)
            get(child(dbRef, currentWeek)).then((snapshot) => {
                let dbData = snapshot.exists() ? snapshot.val() : {};

                // ë°ì´í„° ë³‘í•© (Flattening)
                currentData = defaultPlayers.map(player => {
                    let rowData = { ...player }; // ì´ë¦„, íŒ€ ì •ë³´ ë³µì‚¬
                    
                    // ê° ì¢…ëª©ë³„ ë°ì´í„°ë¥¼ rowDataì— í‰íƒ„í™” (ex: event1_rn_time)
                    eventNames.forEach((_, index) => {
                        const eventKey = `event${index + 1}`;
                        const eventData = dbData[eventKey];
                        const playerEventData = eventData ? eventData[player.name] : null;

                        metrics.forEach(m => {
                            const fullKey = `${eventKey}_${m.key}`;
                            rowData[fullKey] = playerEventData ? (playerEventData[m.key] || "-") : "-";
                        });
                    });
                    return rowData;
                });

                renderTable(currentData);
            }).catch((error) => {
                console.error(error);
                tableBody.innerHTML = '<tr><td colspan="60" style="text-align:center;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>';
            });
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = "";

            data.forEach(person => {
                let row = `<tr>`;
                row += `<td class="sticky-col team-${person.team}">${person.name}</td>`;
                
                eventNames.forEach((_, evIdx) => {
                    metrics.forEach((m, mIdx) => {
                        const isLastMetric = (mIdx === metrics.length - 1);
                        const borderClass = (isLastMetric && evIdx < eventNames.length - 1) ? "event-divider" : "";
                        const fullKey = `event${evIdx + 1}_${m.key}`;
                        
                        let val = person[fullKey];
                        // nullì´ë‚˜ undefined ë°©ì§€
                        if(val === undefined || val === null) val = "-";
                        
                        // 0ì  ì²˜ë¦¬ (í˜¹ì‹œ 0ì´ ì•ˆ ë‚˜ì˜¬ê¹Œë´)
                        if(val === 0) val = "0";

                        row += `<td class="${borderClass}">${val}</td>`;
                    });
                });
                row += `</tr>`;
                tableBody.innerHTML += row;
            });
        }

        function sortTable(key) {
            // key í˜•ì‹: event1_rn_time
            // metric íƒ€ì… ì°¾ê¸°
            const metricKey = key.split('_').slice(1).join('_'); // rn_time, sw_prob ë“±
            const metricInfo = metrics.find(m => m.key === metricKey);
            const type = metricInfo ? metricInfo.type : 'text';

            currentData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                
                // ë°ì´í„° ì—†ëŠ” ê²½ìš° ë§¨ ë’¤ë¡œ
                if (valA === "-" || valA === undefined) return 1;
                if (valB === "-" || valB === undefined) return -1;
                if (valA === "-" && valB === "-") return 0;

                // RETIRE ì²˜ë¦¬ (ê°€ì¥ í° ê°’ ì·¨ê¸‰í•˜ì—¬ ë§¨ ë’¤ë¡œ)
                if (valA === "RETIRE") return 1;
                if (valB === "RETIRE") return -1;

                if (type.includes('float') || type === 'int') {
                    return parseFloat(valA) - parseFloat(valB);
                } else {
                    return valA.toString().localeCompare(valB.toString());
                }
            });
            renderTable(currentData);
        }

        async function saveRecord() {
            const name = document.getElementById('inputNameSelect').value;
            const event = document.getElementById('inputEventSelect').value; // event1
            const metricKey = document.getElementById('inputMetricSelect').value; // rn_time
            
            // ì„ íƒëœ metricì˜ íƒ€ì… ì°¾ê¸°
            const metricInfo = metrics.find(m => m.key === metricKey);
            const type = metricInfo.type;

            let inputElem = document.getElementById('inputRecord');
            let rawValue = inputElem.value.trim();
            let finalValue = rawValue;

            if (!name) return alert("ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

            // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ë° ë³€í™˜
            if (rawValue === "") {
                finalValue = null; // ì‚­ì œ
            } else {
                if (type === 'int') {
                    if (isNaN(rawValue)) return alert("ì •ìˆ˜ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    finalValue = parseInt(rawValue);
                } else if (type === 'float_retire') {
                    if (rawValue.toUpperCase() === "RETIRE" || rawValue.toUpperCase() === "R") {
                        finalValue = "RETIRE";
                    } else if (!isNaN(rawValue)) {
                        finalValue = parseFloat(rawValue).toFixed(2);
                    } else {
                        return alert("ìˆ«ì ë˜ëŠ” RETIRE(R)ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    }
                } else if (type === 'float_dash') {
                    if (rawValue === "-") {
                        finalValue = "-";
                    } else if (!isNaN(rawValue)) {
                        finalValue = parseFloat(rawValue).toFixed(2);
                    } else {
                        return alert("ìˆ«ì ë˜ëŠ” - ê¸°í˜¸ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    }
                }
            }

            // DB ê²½ë¡œ: item_week1 / event1 / ì´ë¦„ / rn_time
            const playerInfo = defaultPlayers.find(p => p.name === name);
            const team = playerInfo ? playerInfo.team : "brown";

            const userRef = ref(db, `${currentWeek}/${event}/${name}`);

            get(userRef).then((snapshot) => {
                let newData = snapshot.exists() ? snapshot.val() : { name: name, team: team };
                
                if (finalValue === null) delete newData[metricKey];
                else newData[metricKey] = finalValue;
                
                newData.team = team;

                set(userRef, newData).then(() => {
                    loadData(); 
                    inputElem.value = ""; 
                    inputElem.focus(); 
                }).catch((error) => {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
                });
            });
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        initUI();
        loadData();
    </script>
</body>
</html>