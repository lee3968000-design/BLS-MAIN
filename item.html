<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì´í…œì „ ê¸°ë¡</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f0f2f5; }
        h1 { text-align: center; color: #333; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
        select, button, input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #444; color: white; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #666; }
        button.save-btn { background-color: #007bff; border-color: #007bff; }
        button.save-btn:hover { background-color: #0056b3; }
        button.reset-btn { background-color: #dc3545; border-color: #dc3545; }
        button.reset-btn:hover { background-color: #c82333; }
        .home-btn { background-color: #333 !important; margin-right: 15px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; border-right: 1px solid #eee; }
        
        /* í—¤ë” ê³ ì • */
        th { background-color: #444; color: white; user-select: none; position: sticky; top: 0; z-index: 20; }
        
        /* ì´ë¦„ ì»¬ëŸ¼ ê³ ì • (Sticky) */
        .sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 30; 
            background-color: #fff; 
            border-right: 2px solid #ddd;
        }
        th.sticky-col { z-index: 40; background-color: #444; }

        /* íŒ€ ìƒ‰ìƒ */
        .team-purple { border-left: 5px solid #800080; background-color: #fcf0fc; color: #800080; font-weight: bold; }
        .team-green { border-left: 5px solid #008000; background-color: #f0fcf0; color: #008000; font-weight: bold; }
        .team-yellow { border-left: 5px solid #DAA520; background-color: #fcfcf0; color: #DAA520; font-weight: bold; }
        .team-blue { border-left: 5px solid #0000FF; background-color: #f0f0fc; color: #0000FF; font-weight: bold; }
        .team-red { border-left: 5px solid #FF0000; background-color: #fcf0f0; color: #FF0000; font-weight: bold; }
        .team-brown { border-left: 5px solid #A52A2A; background-color: #fcf5f0; color: #A52A2A; font-weight: bold; }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        #adminPanel { display: none; border: 2px solid #444; padding: 20px; margin-top: 20px; background: #fff; border-radius: 8px; }
        .input-group { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        /* ì´ë™ ë²„íŠ¼ */
        .move-btn { background: none; border: none; color: #aaa; cursor: pointer; font-size: 10px; padding: 0 2px; }
        .move-btn:hover { color: #fff; }
        .th-content { display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* í˜„ì¬ ì„ íƒëœ ì¢…ëª© í‘œì‹œ */
        #currentEventTitle { width: 100%; text-align: center; margin: 10px 0; font-size: 1.2em; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

    <h1>ğŸ° ì•„ì´í…œì „ ê¸°ë¡</h1>

    <div class="controls">
        <button onclick="location.href='index.html'" class="home-btn">ğŸ  í™ˆìœ¼ë¡œ</button>

        <label>ğŸ“… ì£¼ì°¨:</label>
        <select id="weekSelect" onchange="loadData()">
            <option value="item_week1">1ì£¼ì°¨</option>
            <option value="item_week2">2ì£¼ì°¨</option>
            <option value="item_week3">3ì£¼ì°¨</option>
            <option value="item_week4">4ì£¼ì°¨</option>
            <option value="item_week5">5ì£¼ì°¨</option>
        </select>

        <label>ğŸ® ì¢…ëª©:</label>
        <select id="eventSelect" onchange="loadData()">
            </select>

        <button class="reset-btn" onclick="resetOrder()">â†º ìˆœì„œ ì´ˆê¸°í™”</button>
        <button onclick="toggleAdmin()">âš™ï¸ ê¸°ë¡ ì…ë ¥</button>
    </div>

    <div id="currentEventTitle">ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”</div>

    <div class="table-container">
        <table id="recordTable">
            <thead>
                <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="6" style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="adminPanel">
        <h3>ğŸ“ ì•„ì´í…œì „ ê¸°ë¡ ì…ë ¥</h3>
        <p id="adminEventDisplay" style="color:#007bff; font-weight:bold; margin-bottom:10px;">(í˜„ì¬ ì„ íƒëœ ì¢…ëª©ì— ì…ë ¥ë©ë‹ˆë‹¤)</p>
        
        <div class="input-group">
            <select id="inputNameSelect">
                <option value="">ì„ ìˆ˜ ì„ íƒ</option>
            </select>
            <select id="inputMetricSelect" onchange="updatePlaceholder()">
                </select>
            <input type="text" id="inputRecord" placeholder="ê¸°ë¡ (ì—”í„°í‚¤ë¡œ ì €ì¥)" onkeydown="if(window.event.keyCode == 13){ saveRecord(); }">
            <button class="save-btn" onclick="saveRecord()">ì €ì¥</button>
        </div>
        <p style="font-size: 0.8em; color: gray;">
            * <b>ì‹œê°„(ì™„ì£¼, ìš”ì •)</b> ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬(ì˜ˆ: 12.30)ë¡œ ì €ì¥ë©ë‹ˆë‹¤.<br>
            * ì…ë ¥í•œ ê¸°ë¡ì€ <b>ìœ„ì—ì„œ ì„ íƒí•œ ì£¼ì°¨ ë° ì¢…ëª©</b>ì— ì €ì¥ë©ë‹ˆë‹¤.
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âœ… [ìˆ˜ì •ë¨] ì•„ì´í…œì „ ì¢…ëª© 12ê°œ (ìƒˆ ë¦¬ìŠ¤íŠ¸)
        const eventNames = [
            "ë‹¨ì–´ì¡°í•©", "ì¹´í…Œê³ ë¦¬", "íŠ¸ëœìŠ¤ë ˆí„°", "ì¸ë¬¼í€´ì¦ˆ", 
            "ë‚˜ë¼í€´ì¦ˆ", "ìºì¹˜ë§ˆì¸ë“œ", "ìœ íŠœë¸Œ", "í•˜ì´ë¡œìš°", 
            "ì»¬ëŸ¬ ì²´ì¸ì§€", "í•œìˆ˜ì™„", "ë£°ë ›", "ì´ìƒí˜•"
        ];

        // âœ… [ì„¤ì • 2] ì•„ì´í…œì „ ì¸¡ì • í•­ëª© 5ê°œ
        const metrics = [
            { key: "position", label: "í¬ì§€ì…˜ (ì—­í• )" },
            { key: "solve_count", label: "ë¬¸ì œ í’€ì´ (ê°œ)" },
            { key: "finish_time", label: "ì™„ì£¼ ì‹œê°„ (ì´ˆ)" },
            { key: "items", label: "ì•„ì´í…œ (ì‰´/ìš”/ì²œ)" },
            { key: "fairy_time", label: "ìš”ì • ì‹œê°„ (ì´ˆ)" }
        ];

        let metricOrder = [0, 1, 2, 3, 4];

        // âœ… [ì„¤ì • 3] ì°¸ê°€ì ëª…ë‹¨
        const defaultPlayers = [
            { name: "GMT_ê³¼ë°•", team: "purple" }, { name: "GMT_ë‘ì›”", team: "purple" }, { name: "GMT_ìµëª…", team: "purple" }, { name: "GMT_ì°Œë†", team: "purple" }, { name: "GMT_í›„ì¥", team: "purple" },
            { name: "GS3_ê²Œë¡œ", team: "green" }, { name: "GS3_ì°½ì¡°", team: "green" }, { name: "GS3_ë„´ë¦¬", team: "green" }, { name: "GS3_ì§í”Œ", team: "green" }, { name: "GS3_ì„œì§„", team: "green" },
            { name: "B1A4_ìš´ëª…", team: "yellow" }, { name: "B1A4_ëŸ¬ê°", team: "yellow" }, { name: "B1A4_ì†Œë„¤", team: "yellow" }, { name: "B1A4_ìš°ìœ ", team: "yellow" }, { name: "B1A4_ì§‘ê°€", team: "yellow" },
            { name: "DBT_ëª¨ì§€", team: "blue" }, { name: "DBT_ë¡œë‹ˆ", team: "blue" }, { name: "DBT_ì‚¬ë¥´", team: "blue" }, { name: "DBT_ì§€ë‹ˆ", team: "blue" }, { name: "DBT_í‹°í‹°", team: "blue" },
            { name: "HTML_í•˜ë©œ", team: "red" }, { name: "HTML_ê·¤ê¹Œ", team: "red" }, { name: "HTML_ë¬´í˜¼", team: "red" }, { name: "HTML_í‘ë‘", team: "red" }, { name: "HTML_ì—˜ì œ", team: "red" },
            { name: "BLS_í•œë¹ˆ", team: "brown" }, { name: "BLS_ë„ê°", team: "brown" }, { name: "BLS_ë¬¸ìŠ¤", team: "brown" }, { name: "BLS_ë¸”ìŠ¤", team: "brown" }, { name: "BLS_ì„­ì¢€", team: "brown" }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8",
            measurementId: "G-M9FJXYTS3F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentData = [];
        let currentWeek = "item_week1";
        let currentEvent = "event1"; // ê¸°ë³¸ ì¢…ëª© 1ë²ˆ

        window.loadData = loadData;
        window.saveRecord = saveRecord;
        window.toggleAdmin = toggleAdmin;
        window.sortTable = sortTable;
        window.moveColumn = moveColumn;
        window.resetOrder = resetOrder;
        window.updatePlaceholder = updatePlaceholder;

        function initUI() {
            renderHeader();
            
            // 1. ì¢…ëª© ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒì„± (ìƒˆ ë¦¬ìŠ¤íŠ¸ ë°˜ì˜)
            const eventSelect = document.getElementById('eventSelect');
            let eventOptions = "";
            eventNames.forEach((name, index) => {
                eventOptions += `<option value="event${index + 1}">${name}</option>`;
            });
            eventSelect.innerHTML = eventOptions;

            // 2. ì…ë ¥ì°½ í•­ëª© ìƒì„±
            const selectBox = document.getElementById('inputMetricSelect');
            let optionsHTML = "";
            metrics.forEach((m, index) => {
                optionsHTML += `<option value="${m.key}" data-index="${index}">${m.label}</option>`;
            });
            selectBox.innerHTML = optionsHTML;

            // 3. ì„ ìˆ˜ ëª©ë¡ ìƒì„±
            const nameSelect = document.getElementById('inputNameSelect');
            let nameOptions = `<option value="">ì„ ìˆ˜ ì„ íƒ</option>`;
            defaultPlayers.forEach(p => {
                nameOptions += `<option value="${p.name}">${p.name} (${p.team})</option>`;
            });
            nameSelect.innerHTML = nameOptions;
        }

        function renderHeader() {
            const headerRow = document.getElementById('tableHeaderRow');
            let headerHTML = `<th class="sticky-col" onclick="sortTable('name')">ì´ë¦„ (íŒ€)</th>`;
            
            metricOrder.forEach((originalIndex, displayIndex) => {
                let m = metrics[originalIndex];
                headerHTML += `
                    <th>
                        <div class="th-content">
                            ${displayIndex > 0 ? `<button class="move-btn" onclick="moveColumn(${displayIndex}, -1)">â—€</button>` : ''}
                            <span onclick="sortTable('${m.key}')" style="cursor:pointer">${m.label}</span>
                            ${displayIndex < metrics.length - 1 ? `<button class="move-btn" onclick="moveColumn(${displayIndex}, 1)">â–¶</button>` : ''}
                        </div>
                    </th>
                `;
            });
            headerRow.innerHTML = headerHTML;
        }

        function moveColumn(index, direction) {
            let temp = metricOrder[index];
            metricOrder[index] = metricOrder[index + direction];
            metricOrder[index + direction] = temp;
            renderHeader();
            renderTable(currentData);
        }

        function resetOrder() {
            metricOrder = [0, 1, 2, 3, 4];
            renderHeader();
            renderTable(currentData);
        }

        function updatePlaceholder() {
            const key = document.getElementById('inputMetricSelect').value;
            const input = document.getElementById('inputRecord');
            if(key === 'finish_time' || key === 'fairy_time') {
                input.placeholder = "ì‹œê°„ (ìë™ìœ¼ë¡œ .00 ì²˜ë¦¬ë¨)";
            } else if (key === 'solve_count') {
                input.placeholder = "ë¬¸ì œ ê°œìˆ˜ (ìˆ«ìë§Œ)";
            } else if (key === 'position') {
                input.placeholder = "ì˜ˆ: ìŠ¤ìœ„í¼, ëŸ¬ë„ˆ, ì„œí¬í„°";
            } else {
                input.placeholder = "í…ìŠ¤íŠ¸ ì…ë ¥";
            }
        }

        async function loadData() {
            // ì£¼ì°¨ì™€ ì¢…ëª© ê°’ ê°€ì ¸ì˜¤ê¸°
            currentWeek = document.getElementById('weekSelect').value;
            currentEvent = document.getElementById('eventSelect').value;

            // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¢…ëª© ì´ë¦„ í‘œì‹œ
            const eventIndex = parseInt(currentEvent.replace('event','')) - 1;
            const eventName = eventNames[eventIndex];
            document.getElementById('currentEventTitle').innerText = `${eventName} (${currentWeek.replace('item_week','')}ì£¼ì°¨)`;
            document.getElementById('adminEventDisplay').innerText = `ì…ë ¥ ëŒ€ìƒ: ${eventName} / ${currentWeek.replace('item_week','')}ì£¼ì°¨`;

            const tableBody = document.getElementById('tableBody');
            
            // ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ: ì£¼ì°¨ / ì¢…ëª© / ì‚¬ëŒ
            const dbRef = ref(db);
            const path = `${currentWeek}/${currentEvent}`;

            get(child(dbRef, path)).then((snapshot) => {
                let dbData = [];
                if (snapshot.exists()) {
                    dbData = Object.values(snapshot.val());
                }

                currentData = defaultPlayers.map(player => {
                    const record = dbData.find(d => d.name === player.name);
                    return record ? { ...player, ...record } : player;
                });

                renderTable(currentData);
            }).catch((error) => {
                console.error(error);
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>';
            });
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = "";

            data.forEach(person => {
                let row = `<tr>`;
                row += `<td class="sticky-col team-${person.team}">${person.name}</td>`;
                
                metricOrder.forEach(originalIndex => {
                    let key = metrics[originalIndex].key;
                    let record = person[key] || "-";
                    row += `<td>${record}</td>`;
                });

                row += `</tr>`;
                tableBody.innerHTML += row;
            });
        }

        function sortTable(key) {
            if (key === 'name') {
                currentData.sort((a, b) => a.name.localeCompare(b.name));
            } else {
                currentData.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];
                    
                    if (!valA) return 1; if (!valB) return -1;

                    if (key === 'solve_count' || key === 'finish_time' || key === 'fairy_time') {
                        return parseFloat(valA) - parseFloat(valB);
                    }
                    return valA.toString().localeCompare(valB.toString());
                });
            }
            renderTable(currentData);
        }

        async function saveRecord() {
            const name = document.getElementById('inputNameSelect').value;
            const key = document.getElementById('inputMetricSelect').value;
            let recordInput = document.getElementById('inputRecord');
            let record = recordInput.value.trim();

            if (!name) return alert("ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

            const playerInfo = defaultPlayers.find(p => p.name === name);
            const team = playerInfo ? playerInfo.team : "brown";

            if (record !== "") {
                if (key === 'finish_time' || key === 'fairy_time') {
                    if(!isNaN(record)) record = parseFloat(record).toFixed(2);
                    else return alert("ì‹œê°„ì€ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                } else if (key === 'solve_count') {
                    if(!isNaN(record)) record = parseInt(record);
                    else return alert("ê°œìˆ˜ëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
            } else {
                record = null;
            }

            // ì €ì¥ ê²½ë¡œë„ ì£¼ì°¨/ì¢…ëª©/ì´ë¦„ ìˆœì„œ
            const userRef = ref(db, `${currentWeek}/${currentEvent}/${name}`);

            get(userRef).then((snapshot) => {
                let newData = snapshot.exists() ? snapshot.val() : { name: name, team: team };
                
                if (record === null) delete newData[key];
                else newData[key] = record;
                
                newData.team = team;

                set(userRef, newData).then(() => {
                    loadData(); // ì €ì¥ í›„ í…Œì´ë¸” ê°±ì‹ 
                    recordInput.value = ""; 
                    recordInput.focus(); 
                }).catch((error) => {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
                });
            });
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        initUI();
        loadData();
    </script>
</body>
</html>